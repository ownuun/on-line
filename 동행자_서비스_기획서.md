# 동행자 서비스 시스템 기획서

## 1. 서비스 개요

### 1.1 서비스 목적
- **사회적 약자 지원**: 대기열 서기 어려운 사용자를 위한 동행자 매칭 서비스
- **편의성 제공**: 대기 시간 동안 자유롭게 활동 가능
- **수익 창출**: 동행자에게 수익 기회 제공

### 1.2 타겟 사용자
- **서비스 요청자**: 노약자, 임산부, 장애인, 어린이 동반 가족
- **동행자**: 시간 여유가 있는 일반 사용자

## 2. 핵심 기능

### 2.1 동행자 요청 시스템
```
기본 요금: 10,000원
가격 조정: 사용자 설정 가능 (10,000원 이상)
```

### 2.2 동행자 매칭 알고리즘
```
1단계: 현재 위치 ±5칸 범위 검색
2단계: 1분 후 ±10칸으로 확장
3단계: 2분 후 ±15칸으로 확장
4단계: 3분 후 ±20칸으로 확장
최대: ±50칸까지 확장
```

### 2.3 번호 처리 로직
```
- 동행자 번호 = 사회적 약자와 동행자 중 더 뒤의 번호
- 사회적 약자 번호 = 동행자와 동일한 번호 (뒤의 번호)
- 표시: 동행자만 "15번 (동행자)", 사회적 약자는 "15번"
- 이유: 새치기 방지를 위한 공정성 확보
```

## 3. 기술적 구현

### 3.1 데이터베이스 스키마

#### CompanionRequest (동행자 요청)
```typescript
interface CompanionRequest {
  id: string;
  userId: string;           // 요청자 ID
  queueId: string;          // 대기열 ID
  originalQueueNumber: number; // 원래 대기열 번호
  offeredPrice: number;     // 제안 금액
  status: 'pending' | 'matched' | 'completed' | 'cancelled';
  searchRange: number;      // 현재 검색 범위
  createdAt: Date;
  matchedAt?: Date;
  companionId?: string;     // 매칭된 동행자 ID
  linkedQueueNumber?: number; // 연동된 대기열 번호
}
```

#### Companion (동행자)
```typescript
interface Companion {
  id: string;
  userId: string;           // 동행자 ID
  requestId: string;        // 요청 ID
  queueId: string;          // 대기열 ID
  originalQueueNumber: number; // 원래 대기열 번호
  status: 'waiting' | 'called' | 'entered' | 'cancelled';
  earnedAmount: number;     // 획득 금액
  createdAt: Date;
  linkedQueueNumber?: number; // 연동된 대기열 번호
}
```

### 3.2 API 엔드포인트

#### 동행자 요청
```
POST /api/companion/request
- 대기열 ID, 제안 금액으로 동행자 요청

GET /api/companion/requests
- 현재 대기열의 동행자 요청 목록 조회

PUT /api/companion/request/:id/price
- 요청 금액 수정

DELETE /api/companion/request/:id
- 동행자 요청 취소
```

#### 동행자 매칭
```
POST /api/companion/accept/:requestId
- 동행자 요청 수락

GET /api/companion/available
- 수락 가능한 동행자 요청 목록 조회
```

## 4. UI/UX 설계

### 4.1 동행자 요청 화면
```
┌─────────────────────────────┐
│ 동행자 서비스 요청           │
├─────────────────────────────┤
│ 현재 대기열: 15번            │
│ 예상 대기 시간: 30분         │
├─────────────────────────────┤
│ 제안 금액: [10,000원] [수정]│
│ 검색 범위: ±5칸              │
├─────────────────────────────┤
│ [동행자 요청하기]            │
│ [취소]                      │
└─────────────────────────────┘
```

### 4.2 동행자 매칭 화면
```
┌─────────────────────────────┐
│ 동행자 요청 목록             │
├─────────────────────────────┤
│ 15번 (노약자) - 10,000원    │
│ [수락하기]                  │
├─────────────────────────────┤
│ 18번 (임산부) - 15,000원    │
│ [수락하기]                  │
└─────────────────────────────┘
```

### 4.3 대기열 상태 표시
```
┌─────────────────────────────┐
│ 대기열 상태                  │
├─────────────────────────────┤
│ 15번 - 대기 중              │
│ 15번 (동행자) - 대기 중      │
│ 16번 - 대기 중              │
└─────────────────────────────┘
```

## 5. 비즈니스 로직

### 5.1 동행자 검색 알고리즘
```typescript
function findCompanion(request: CompanionRequest): Companion[] {
  const range = request.searchRange;
  const currentNumber = request.originalQueueNumber;
  
  // 범위 내 동행자 검색
  const candidates = getUsersInRange(currentNumber - range, currentNumber + range);
  
  // 조건 필터링
  return candidates.filter(candidate => 
    candidate.isAvailable && 
    candidate.isInterestedInCompanionService
  );
}
```

### 5.2 범위 확장 로직
```typescript
function expandSearchRange(requestId: string): void {
  const request = getCompanionRequest(requestId);
  const elapsedMinutes = getElapsedMinutes(request.createdAt);
  
  // 1분마다 범위 확장
  const newRange = Math.min(5 + (elapsedMinutes * 5), 50);
  
  updateCompanionRequest(requestId, { searchRange: newRange });
}
```

### 5.3 번호 연동 처리
```typescript
function processQueueNumberLinking(requestId: string, companionId: string): void {
  const request = getCompanionRequest(requestId);
  const companion = getCompanion(companionId);
  
  // 두 사용자의 원래 번호 비교
  const requestNumber = request.originalQueueNumber;
  const companionNumber = companion.originalQueueNumber;
  
  // 더 뒤의 번호로 통일
  const linkedNumber = Math.max(requestNumber, companionNumber);
  
  // 두 사용자의 대기열 번호 업데이트
  updateQueueEntry(request.queueId, request.userId, {
    queueNumber: linkedNumber,
    isCompanionService: true,
    companionType: 'requester',
    displayLabel: '' // 사회적 약자는 라벨 없음
  });
  
  updateQueueEntry(companion.queueId, companion.userId, {
    queueNumber: linkedNumber,
    isCompanionService: true,
    companionType: 'companion',
    displayLabel: '(동행자)' // 동행자만 라벨 표시
  });
}
```

### 5.4 결제 처리
```typescript
function processCompanionPayment(requestId: string, companionId: string): void {
  const request = getCompanionRequest(requestId);
  
  // 요청자에서 동행자로 금액 이체
  transferMoney(request.userId, companionId, request.offeredPrice);
  
  // 수수료 처리 (플랫폼 수수료 10%)
  const platformFee = request.offeredPrice * 0.1;
  transferToPlatform(platformFee);
}
```

## 6. 보안 및 검증

### 6.1 신원 확인
- 동행자 신원증 업로드
- 범죄 이력 조회
- 평점 시스템

### 6.2 사기 방지
- 동일 사용자 간 매칭 방지
- 과도한 요청 제한
- 이상 거래 모니터링

## 7. 구현 우선순위

### Phase 1 (MVP)
- [ ] 기본 동행자 요청/수락 기능
- [ ] 범위 기반 검색 알고리즘
- [ ] 기본 UI 구현

### Phase 2 (고도화)
- [ ] 동적 범위 확장
- [ ] 가격 조정 기능
- [ ] 결제 시스템 연동

### Phase 3 (안정화)
- [ ] 신원 확인 시스템
- [ ] 평점 및 리뷰 시스템
- [ ] 사기 방지 시스템

## 8. 예상 효과

### 8.1 사용자 만족도
- 사회적 약자: 대기 시간 자유 활용
- 동행자: 수익 창출 기회

### 8.2 비즈니스 효과
- 플랫폼 수수료 수익
- 사용자 유지율 향상
- 사회적 가치 창출
